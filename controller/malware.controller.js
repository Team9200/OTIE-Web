import Malware from '../database/models/malware';

function get(req, res) {

	var page = req.query.page;
	Malware.find({}).skip(10 * (page - 1)).limit(10).then((data) => {
			res.json({
				success: true,
				message: data
			});
		})
		.catch((err) => {
			res.json({
				success: false,
				message: err
			});
		});

}

function search(req, res) {

	var query = req.query.query; // get query
	var type = req.query.type; // get type
	var page = req.query.page;

	if (type === "tag") { // tag \


		Malware.find({
				tag_name_etc: {
					$elemMatch: {
						"tag": query
					}
				}
			}).skip(10 * (page - 1)).limit(10).then((data) => {
				res.json({
					success: true,
					message: data
				});
			})
			.catch((err) => {
				res.json({
					success: false,
					message: err
				});
			});

	} else if (type === "hash") { // hash

		if (query.length === 32) { //md5

			Malware.find({
					"md5": query
				}).skip(10 * (page - 1)).limit(10).then((data) => {
					res.json({
						success: true,
						message: data
					});
				})
				.catch((err) => {
					res.json({
						success: false,
						message: err
					});
				});

		} else if (query.length === 40) { //sha1

			Malware.find({
					"sha1": query
				}).skip(10 * (page - 1)).limit(10).then((data) => {
					res.json({
						success: true,
						message: data
					});
				})
				.catch((err) => {
					res.json({
						success: false,
						message: err
					});
				});


		} else if (query.length === 64) { //sha256

			Malware.find({
					"sha256": query
				}).skip(10 * (page - 1)).limit(10).then((data) => {
					res.json({
						success: true,
						message: data
					});
				})
				.catch((err) => {
					res.json({
						success: false,
						message: err
					});
				});

		}

	} else if (type === "col") {

		Malware.find({
				"collector": query
			}).skip(10 * (page - 1)).limit(10).then((data) => {
				res.json({
					success: true,
					message: data
				});
			})
			.catch((err) => {
				res.json({
					success: false,
					message: err
				});
			});

	} else if (type === "ana") {

		Malware.find({
				"analyzer": query
			}).skip(10 * (page - 1)).limit(10).then((data) => {
				res.json({
					success: true,
					message: data
				});
			})
			.catch((err) => {
				res.json({
					success: false,
					message: err
				});
			});

	} else {

		return res.json({
			success: false,
			message: 'Query error'
		});
	}
}

export default {
	get,
	search
};